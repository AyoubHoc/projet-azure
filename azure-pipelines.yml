trigger:
  branches:
    include:
      - main

variables:
  - group: InfraSettings
  azureSubscription: 'AzureSPN'

stages:
- stage: Build
  jobs:
  - job: BuildBackend
    pool: { vmImage: ubuntu-latest }
    steps:
      - task: UsePythonVersion@0
        inputs: { versionSpec: '3.x' }
      - script: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        displayName: 'Install Python deps'

- stage: Deploy
  dependsOn: Build
  jobs:
  - deployment: DeployAPI
    environment: 'production'
    pool: { vmImage: ubuntu-latest }
    strategy:
      runOnce:
        deploy:
          steps:
            - task: AzureWebApp@1
              displayName: 'Deploy Flask App'
              inputs:
                azureSubscription: $(azureSubscription)
                appType: webAppLinux
                appName: $(apiAppName)
                package: backend
                startupCommand: 'gunicorn --bind=0.0.0.0 --timeout 600 app:app'
            - task: AzureCLI@2
              displayName: 'Set KEYVAULT_NAME'
              inputs:
                azureSubscription: $(azureSubscription)
                scriptType: bash
                scriptLocation: inlineScript
                inlineScript: |
                  az webapp config appsettings set \
                    -g $(resourceGroup) -n $(apiAppName) \
                    --settings KEYVAULT_NAME=$(keyVaultName)
